rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    // Helper functions pour vérifier l'authentification et les permissions
    
    // Vérifie si l'utilisateur est authentifié
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Vérifie si l'utilisateur existe dans Firestore
    function userExists(userId) {
      return exists(/databases/$(database)/documents/users/$(userId));
    }
    
    function isSystemAdmin() {
      return isAuthenticated() && 
             exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.get('isAdmin', false) == true;
    }
    
    // Vérifie si l'utilisateur appartient à une entreprise ou est admin système
    function hasEnterprise(enterpriseId) {
      return isSystemAdmin() || (isAuthenticated() && (
        (exists(/databases/$(database)/documents/users/$(request.auth.uid)) && (
          get(/databases/$(database)/documents/users/$(request.auth.uid)).data.get('enterpriseIds', []).hasAny([enterpriseId]) ||
          enterpriseId in get(/databases/$(database)/documents/users/$(request.auth.uid)).data.get('enterprises', {})
        )) ||
        // Fallback: check if an assignment document exists for this user/enterprise
        exists(/databases/$(database)/documents/enterprise_module_users/$(request.auth.uid + "_" + enterpriseId + "_gaz")) ||
        exists(/databases/$(database)/documents/enterprise_module_users/$(request.auth.uid + "_" + enterpriseId + "_boutique")) ||
        exists(/databases/$(database)/documents/enterprise_module_users/$(request.auth.uid + "_" + enterpriseId + "_eau_minerale")) ||
        exists(/databases/$(database)/documents/enterprise_module_users/$(request.auth.uid + "_" + enterpriseId + "_immobilier")) ||
        exists(/databases/$(database)/documents/enterprise_module_users/$(request.auth.uid + "_" + enterpriseId + "_orange_money"))
      ));
    }

    // Vérifie l'accès à une entreprise ou à ses parents (hiérarchie)
    function hasEffectiveAccess(enterpriseId) {
      return isSystemAdmin() || 
             hasEnterprise(enterpriseId) || 
             (exists(/databases/$(database)/documents/enterprises/$(enterpriseId)) && 
              hasEnterprise(get(/databases/$(database)/documents/enterprises/$(enterpriseId)).data.get('parentEnterpriseId', '')));
    }
    
    // Vérifie si l'utilisateur est admin de l'entreprise
    function isEnterpriseAdmin(enterpriseId) {
      return isSystemAdmin() || 
             (isAuthenticated() && 
              exists(/databases/$(database)/documents/users/$(request.auth.uid)) && 
              'enterprises' in get(/databases/$(database)/documents/users/$(request.auth.uid)).data && 
              enterpriseId in get(/databases/$(database)/documents/users/$(request.auth.uid)).data.enterprises && 
              'role' in get(/databases/$(database)/documents/users/$(request.auth.uid)).data.enterprises[enterpriseId] &&
              get(/databases/$(database)/documents/users/$(request.auth.uid)).data.enterprises[enterpriseId].role == 'admin');
    }
    
    // Vérifie si l'utilisateur a une permission spécifique dans une entreprise
    function hasPermission(enterpriseId, permission) {
      return isSystemAdmin() ||
             (isAuthenticated() && exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
              (isEnterpriseAdmin(enterpriseId) ||
               ('enterprises' in get(/databases/$(database)/documents/users/$(request.auth.uid)).data &&
                enterpriseId in get(/databases/$(database)/documents/users/$(request.auth.uid)).data.enterprises &&
                'permissions' in get(/databases/$(database)/documents/users/$(request.auth.uid)).data.enterprises[enterpriseId] &&
                get(/databases/$(database)/documents/users/$(request.auth.uid)).data.enterprises[enterpriseId].permissions.hasAny([permission]))));
    }
    
    // Collection des utilisateurs
    match /users/{userId} {
      // Un utilisateur peut lire son propre document
      // Les admins peuvent lire tous les utilisateurs
      allow read: if isAuthenticated() && (
        resource == null ||
        request.auth.uid == userId || 
        isSystemAdmin()
      );
      
      // Seul un admin peut créer/modifier un utilisateur
      allow write: if isAuthenticated() && (
        // L'utilisateur peut mettre à jour son propre profil (sauf isAdmin et enterprises)
        // Note: L'utilisateur PEUT mettre à jour enterpriseIds pour la synchronisation locale
        (request.auth.uid == userId && 
         (
           (resource == null && !request.resource.data.keys().hasAny(['isAdmin', 'enterprises'])) ||
           (resource != null && !request.resource.data.diff(resource.data).affectedKeys().hasAny(['isAdmin', 'enterprises']))
         )) ||
        // Un admin système peut créer/modifier n'importe quel utilisateur
        isSystemAdmin()
      );
    }
    
    // Collection des entreprises
    match /enterprises/{enterpriseId} {
      // Les admins système peuvent tout lire, les autres seulement s'ils appartiennent à l'entreprise
      allow read: if isSystemAdmin() || resource == null || hasEffectiveAccess(enterpriseId);
      
      // Seuls les admins système peuvent créer/modifier une entreprise
      // Les admins d'entreprise peuvent modifier leur entreprise
      allow write: if isSystemAdmin() || isEnterpriseAdmin(enterpriseId);
      
      // Sous-collections spécifiques à chaque module
      // Pattern: /enterprises/{enterpriseId}/{collection}/{documentId}
      
      // Module Boutique
      match /sales/{saleId} {
        allow read, write: if hasEffectiveAccess(enterpriseId);
      }
      
      match /products/{productId} {
        allow read: if hasEffectiveAccess(enterpriseId);
        allow write: if hasPermission(enterpriseId, 'boutique:manage_products');
      }
      
      match /expenses/{expenseId} {
        allow read, write: if hasEffectiveAccess(enterpriseId);
      }
      
      match /purchases/{purchaseId} {
        allow read, write: if hasEffectiveAccess(enterpriseId);
      }
      
      // Module Eau Minérale
      match /customers/{customerId} {
        allow read, write: if hasEffectiveAccess(enterpriseId);
      }
      
      match /machines/{machineId} {
        allow read: if hasEffectiveAccess(enterpriseId);
        allow write: if hasPermission(enterpriseId, 'eau_minerale:manage_machines');
      }
      
      match /bobines/{bobineId} {
        allow read: if hasEffectiveAccess(enterpriseId);
        allow write: if hasPermission(enterpriseId, 'eau_minerale:manage_bobines');
      }
      
      match /productionSessions/{sessionId} {
        allow read, write: if hasEffectiveAccess(enterpriseId);
      }
      
      match /employees/{employeeId} {
        allow read: if hasEffectiveAccess(enterpriseId);
        allow write: if hasPermission(enterpriseId, 'eau_minerale:manage_employees');
      }
      
      match /salaryPayments/{paymentId} {
        allow read: if hasEffectiveAccess(enterpriseId);
        allow write: if hasPermission(enterpriseId, 'eau_minerale:manage_payments');
      }
      
      match /productionPayments/{paymentId} {
        allow read, write: if hasEffectiveAccess(enterpriseId);
      }
      
      match /creditPayments/{paymentId} {
        allow read, write: if hasEffectiveAccess(enterpriseId);
      }
      
      match /dailyWorkers/{workerId} {
        allow read, write: if hasEffectiveAccess(enterpriseId);
      }
      
      match /bobineStocks/{stockId} {
        allow read, write: if hasEffectiveAccess(enterpriseId);
      }
      
      match /bobineStockMovements/{movementId} {
        allow read, write: if hasEffectiveAccess(enterpriseId);
      }
      
      match /expenseRecords/{expenseId} {
        allow read, write: if hasEffectiveAccess(enterpriseId);
      }
      
      match /stockItems/{itemId} {
        allow read, write: if hasEffectiveAccess(enterpriseId);
      }
      
      match /stockMovements/{movementId} {
        allow read, write: if hasEffectiveAccess(enterpriseId);
      }
      
      match /packagingStocks/{stockId} {
        allow read, write: if hasEffectiveAccess(enterpriseId);
      }
      
      match /packagingStockMovements/{movementId} {
        allow read, write: if hasEffectiveAccess(enterpriseId);
      }
      
      // Module Orange Money
      match /agents/{agentId} {
        allow read: if hasEffectiveAccess(enterpriseId);
        allow write: if hasPermission(enterpriseId, 'orange_money:manage_agents');
      }
      
      match /transactions/{transactionId} {
        allow read, write: if hasEffectiveAccess(enterpriseId);
      }
      
      match /commissions/{commissionId} {
        allow read: if hasEffectiveAccess(enterpriseId);
        allow write: if hasPermission(enterpriseId, 'orange_money:manage_commissions');
      }
      
      match /liquidityCheckpoints/{checkpointId} {
        allow read, write: if hasEffectiveAccess(enterpriseId);
      }
      
      match /orangeMoneySettings/{settingsId} {
        allow read: if hasEffectiveAccess(enterpriseId);
        allow write: if hasPermission(enterpriseId, 'orange_money:manage_settings');
      }
      
      // Module Immobilier
      match /properties/{propertyId} {
        allow read: if hasEffectiveAccess(enterpriseId);
        allow write: if hasPermission(enterpriseId, 'immobilier:manage_properties');
      }
      
      match /tenants/{tenantId} {
        allow read, write: if hasEffectiveAccess(enterpriseId);
      }
      
      match /contracts/{contractId} {
        allow read, write: if hasEffectiveAccess(enterpriseId);
      }
      
      match /payments/{paymentId} {
        allow read, write: if hasEffectiveAccess(enterpriseId);
      }
      
      match /propertyExpenses/{expenseId} {
        allow read, write: if hasEffectiveAccess(enterpriseId);
      }
      
      // Module Gaz
      match /gasSales/{saleId} {
        allow read, write: if hasEffectiveAccess(enterpriseId);
      }
      
      match /cylinders/{cylinderId} {
        allow read: if isAuthenticated();
        allow write: if hasPermission(enterpriseId, 'gaz:manage_cylinders');
      }
      
      match /cylinderStocks/{stockId} {
        allow read, write: if hasEffectiveAccess(enterpriseId);
      }
      
      match /pointsOfSale/{posId} {
        allow read: if hasEnterprise(enterpriseId) || hasEnterprise(posId);
        allow write: if isSystemAdmin() || isEnterpriseAdmin(enterpriseId) || isEnterpriseAdmin(posId) || hasPermission(enterpriseId, 'gaz:manage_pos');
      }
 
      match /agences/{agenceId} {
        allow read: if hasEnterprise(enterpriseId) || hasEnterprise(agenceId);
        allow write: if isSystemAdmin() || isEnterpriseAdmin(enterpriseId) || isEnterpriseAdmin(agenceId);
      }
      
      match /tours/{tourId} {
        allow read, write: if hasEffectiveAccess(enterpriseId);
      }
      
      match /gazExpenses/{expenseId} {
        allow read, write: if hasEffectiveAccess(enterpriseId);
      }
      
      match /cylinderLeaks/{leakId} {
        allow read, write: if hasEffectiveAccess(enterpriseId);
      }
      
      // Paramètres partagés (Lecture autorisée pour tout utilisateur authentifié du module)
      match /gazSettings/{settingId} {
        allow read: if isAuthenticated();
        allow write: if hasPermission(enterpriseId, 'gaz:manage_settings');
      }
 
      match /wholesalers/{wholesalerId} {
        allow read: if isAuthenticated();
        allow write: if hasPermission(enterpriseId, 'gaz:manage_wholesalers');
      }
 
      match /inventoryAudits/{auditId} {
        allow read: if hasEffectiveAccess(enterpriseId);
        allow write: if hasPermission(enterpriseId, 'gaz:manage_stocks');
      }
 
      match /stockTransfers/{transferId} {
        allow read, write: if hasEffectiveAccess(enterpriseId);
      }
 
      match /gasCollections/{collectionId} {
        allow read, write: if hasEffectiveAccess(enterpriseId);
      }
 
      match /gazSessions/{sessionId} {
        allow read, write: if hasEffectiveAccess(enterpriseId);
      }
 
      match /gazTreasuryOperations/{opId} {
        allow read, write: if hasEffectiveAccess(enterpriseId);
      }
 
      match /auditTrail/{logId} {
        allow read: if hasEffectiveAccess(enterpriseId);
        allow write: if isAuthenticated(); // Permettre d'écrire des logs d'audit depuis l'app
      }
 
      match /boutiqueSettings/{settingsId} {
        allow read: if hasEffectiveAccess(enterpriseId);
        allow write: if hasPermission(enterpriseId, 'boutique:manage_settings');
      }
 
      match /financialReports/{reportId} {
        allow read: if hasEffectiveAccess(enterpriseId);
        allow write: if hasPermission(enterpriseId, 'gaz:view_reports') || 
                         isEnterpriseAdmin(enterpriseId);
      }
      
      // Pattern générique pour les autres collections
      // Permet d'ajouter de nouvelles collections sans modifier les règles
      match /{collection}/{document=**} {
        // Par défaut, permettre la lecture/écriture si l'utilisateur appartient à l'entreprise
        // Les règles spécifiques ci-dessus prennent le dessus
        allow read, write: if hasEffectiveAccess(enterpriseId);
      }
    }
    
    // Règles pour collection groups (supporte pullEnterprisesFromFirestore via collectionGroup)
    match /{path=**}/pointsOfSale/{posId} {
      allow read: if isSystemAdmin() || hasEffectiveAccess(posId);
    }
    
    match /{path=**}/agences/{agenceId} {
      allow read: if isSystemAdmin() || hasEffectiveAccess(agenceId);
    }
    
    // Collection globale des rôles (administration)
    match /roles/{roleId} {
      // Tous les utilisateurs authentifiés peuvent lire les rôles
      allow read: if isAuthenticated();
      
      // Seuls les admins système peuvent créer/modifier/supprimer des rôles
      allow write: if isSystemAdmin();
    }
    
    // Collection globale des assignations utilisateurs-entreprises-modules
    match /enterprise_module_users/{documentId} {
      // Les utilisateurs authentifiés peuvent lire leurs propres assignations
      // Les admins système peuvent tout lire
      allow read: if isAuthenticated() && (
        resource == null || // Allow queries to be evaluated
        resource.data.userId == request.auth.uid || 
        isSystemAdmin() ||
        hasEffectiveAccess(resource.data.enterpriseId) ||
        (resource.data.get('parentEnterpriseId', '') != '' && hasEffectiveAccess(resource.data.parentEnterpriseId))
      );
      
      // Seuls les admins système peuvent créer/modifier/supprimer des assignations
      allow write: if isSystemAdmin();
    }
    
    // Autres collections globales (si nécessaire)
    // Exemple : notifications globales, configurations système, etc.
    
    // Collection audit_logs (si utilisée)
    match /audit_logs/{logId} {
      // Seuls les admins système peuvent lire les logs d'audit complets
      // Les utilisateurs peuvent créer des logs pour leurs propres actions
      allow read: if isSystemAdmin();
      allow create: if isAuthenticated() && (request.resource.data.userId == request.auth.uid || isSystemAdmin());
      allow update, delete: if isSystemAdmin();
    }
  }
}
