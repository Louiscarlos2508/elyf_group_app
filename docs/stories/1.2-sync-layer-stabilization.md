# Story 1.2: Sync Layer Stabilization

**Status**: Done
**Role**: Developer
**Epic**: 1 (Cleanup & Reliability)

## Description
Verify and harden the synchronization layer so that `globalSyncManager`, `FirestoreSyncService`, and related components correctly handle all collection paths defined in `sync_paths.dart` / `bootstrap.dart`, and that offline operations are robust with sync resuming correctly after network changes.

## Story
**As a** developer/maintainer,
**I want** the sync layer to be verified and documented against the single source of truth for collection paths,
**so that** we avoid missing or inconsistent Firestore mappings and ensure reliable offline-first behavior.

## Acceptance Criteria
- [x] All collection names used by feature modules (Drift/offline repos) are present in `lib/core/offline/sync_paths.dart` and are passed to `FirebaseSyncHandler` / `GlobalModuleRealtimeSyncService` via `bootstrap.dart`.
- [x] Sync resumes correctly after network loss and restore (e.g. connectivity change); no silent skip of collections.
- [x] `docs/brownfield-architecture.md` is updated with a short "Sync layer" subsection: where paths are defined, how they are wired in bootstrap, and that new feature collections must be registered in `sync_paths.dart`.

## Tasks
- [x] Audit `lib/core/offline/sync_paths.dart`: list every key; cross-check with all feature offline repositories / collection names (administration, boutique, eau_minerale, gaz, orange_money, immobilier) and add any missing entries (AC1).
- [x] Trace bootstrap: confirm `collectionPaths` from `sync_paths.dart` is the single map used for `FirebaseSyncHandler`, `GlobalModuleRealtimeSyncService`, and any other sync services (AC1).
- [x] Verify connectivity and sync resume: ensure `SyncManager` / connectivity handling triggers sync when coming back online; add or run a minimal smoke test or manual test scenario (AC2).
- [x] Update `docs/brownfield-architecture.md` with a "Sync layer" subsection describing path definition, bootstrap wiring, and the rule that new collections must be registered in `sync_paths.dart` (AC3).

## Dev Notes
- **Source of truth for paths**: `lib/core/offline/sync_paths.dart` — single map `collectionPaths` used in `bootstrap.dart` for `FirebaseSyncHandler(collectionPaths: collectionPaths)` and `GlobalModuleRealtimeSyncService(collectionPaths: collectionPaths)`.
- **Bootstrap wiring**: `lib/app/bootstrap.dart` initializes `globalSyncManager` with `FirebaseSyncHandler` and later `GlobalModuleRealtimeSyncService`; both receive the same `collectionPaths` from `sync_paths.dart`.
- **Key types**: `Map<String, String Function(String?)>` — key is logical collection name (e.g. `'sales'`, `'enterprise_module_users'`); value is a function that builds the Firestore path (often `enterprises/$enterpriseId/...`).
- **Relevant files**: `lib/core/offline/sync_manager.dart`, `lib/core/offline/handlers/firebase_sync_handler.dart`, `lib/core/offline/global_module_realtime_sync_service.dart`, `lib/core/offline/module_realtime_sync_service.dart`, `lib/core/offline/connectivity_service.dart`. Feature repos reference collection names (e.g. `productionPaymentsCollection`) that must exist in `sync_paths.dart`.

## Testing
- Run existing tests; add or run one scenario that exercises sync/connectivity (e.g. unit test for path resolution or integration test for "sync after reconnect" if feasible).
- Manual: start app, go offline, make changes, go online — confirm sync runs and data appears in Firestore (or local state consistent with sync).

## Change Log
- (Draft) Story created from PRD R2 and brownfield-architecture implementation priorities.
- (Done) Audit confirmed all feature repo collection names exist in `sync_paths.dart`. Bootstrap uses single `collectionPaths` from `sync_paths.dart` for FirebaseSyncHandler and GlobalModuleRealtimeSyncService. SyncManager + ConnectivityService handle reconnect; sync resumes when back online. brownfield-architecture.md updated with Sync layer subsection.
